---
title: "Using Randomization & Stratification to Overcome A Common Cause Confounder"
format:
  html: default
bibliography: references.bib
execute:
  echo: false
  eval: true
---

```{python}
#| label: load-data-python
#| echo: false

import pandas as pd

# Load the observational data
patients_df = pd.read_csv('patients_data.csv')
```

```{python}
#| label: load-data-randomized-python
#| echo: false

import pandas as pd

# Load the randomized data
patients_randomized_df = pd.read_csv('patients_data_randomized.csv')
```

### Figure 1 - Post-Surgical Outcomes by Patient

```{python}
#| label: fig-plot-outcomes
#| fig-cap: "Post-Surgical Symptom Score (lower is better) - Observed Data"
#| echo: false

import matplotlib.pyplot as plt
import numpy as np

# Separate data by doctor
dreamy_data = patients_df[patients_df['doctor_name'] == 'Doc Dreamy']
duck_data = patients_df[patients_df['doctor_name'] == 'Doc Duck']

# Calculate means
dreamy_mean = dreamy_data['post_surgical_score'].mean()
duck_mean = duck_data['post_surgical_score'].mean()

# Create figure with professional styling
fig, ax = plt.subplots(figsize=(7, 4))

# Plot scatter points
# Doc Dreamy: circles, blue
ax.scatter(dreamy_data['patient'], dreamy_data['post_surgical_score'], 
           marker='o', color='#4E79A7', s=60, alpha=0.7, label='Doc Dreamy', zorder=3)

# Doc Duck: triangles, coral/red-orange
ax.scatter(duck_data['patient'], duck_data['post_surgical_score'], 
           marker='^', color='#E15759', s=60, alpha=0.7, label='Doc Duck', zorder=3)

# Add horizontal dashed lines for means
ax.axhline(y=dreamy_mean, color='#4E79A7', linestyle='--', linewidth=1.5, alpha=0.8, zorder=2)
ax.axhline(y=duck_mean, color='#E15759', linestyle='--', linewidth=1.5, alpha=0.8, zorder=2)

# Add text annotations with shape symbols
ax.text(102, dreamy_mean, f'○ {dreamy_mean:.2f}', 
        color='#4E79A7', fontsize=11, va='center', fontweight='bold')
ax.text(102, duck_mean, f'△ {duck_mean:.2f}', 
        color='#E15759', fontsize=11, va='center', fontweight='bold')

# Professional styling
ax.set_xlabel('Patient Number', fontsize=12, fontweight='bold')
ax.set_ylabel('Post-Surgical Symptom Score (Lower is Better)', fontsize=12, fontweight='bold')
ax.set_title('Post-Surgical Symptom Score by Patient and Doctor', fontsize=14, fontweight='bold', pad=15)
ax.grid(True, alpha=0.3, linestyle='-', linewidth=0.5)
ax.legend(loc='upper right', fontsize=11, framealpha=0.9)
ax.set_xlim(-2, 110)

# Adjust tick labels
ax.tick_params(labelsize=10)

plt.tight_layout()
plt.show()

```



### Figure 2 — Randomized Assignment Outcomes

```{python}
#| label: fig-plot-outcomes-randomized
#| fig-cap: "Post-Surgical Symptom Score (lower is better) for randomized patients."
#| echo: false

import matplotlib.pyplot as plt
import numpy as np

# Separate randomized data by doctor
dreamy_data_rand = patients_randomized_df[patients_randomized_df['doctor_name'] == 'Doc Dreamy']
duck_data_rand = patients_randomized_df[patients_randomized_df['doctor_name'] == 'Doc Duck']

# Calculate means
dreamy_mean_rand = dreamy_data_rand['post_surgical_score'].mean()
duck_mean_rand = duck_data_rand['post_surgical_score'].mean()

# Create figure with professional styling
fig, ax = plt.subplots(figsize=(7, 4))

# Plot scatter points
# Doc Dreamy: circles, blue
ax.scatter(dreamy_data_rand['patient'], dreamy_data_rand['post_surgical_score'], 
           marker='o', color='#4E79A7', s=60, alpha=0.7, label='Doc Dreamy', zorder=3)

# Doc Duck: triangles, coral/red-orange
ax.scatter(duck_data_rand['patient'], duck_data_rand['post_surgical_score'], 
           marker='^', color='#E15759', s=60, alpha=0.7, label='Doc Duck', zorder=3)

# Add horizontal dashed lines for means
ax.axhline(y=dreamy_mean_rand, color='#4E79A7', linestyle='--', linewidth=1.5, alpha=0.8, zorder=2)
ax.axhline(y=duck_mean_rand, color='#E15759', linestyle='--', linewidth=1.5, alpha=0.8, zorder=2)

# Add text annotations with shape symbols
ax.text(102, dreamy_mean_rand, f'○ {dreamy_mean_rand:.2f}', 
        color='#4E79A7', fontsize=11, va='center', fontweight='bold')
ax.text(102, duck_mean_rand, f'△ {duck_mean_rand:.2f}', 
        color='#E15759', fontsize=11, va='center', fontweight='bold')

# Professional styling
ax.set_xlabel('Patient Number', fontsize=12, fontweight='bold')
ax.set_ylabel('Post-Surgical Symptom Score (Lower is Better)', fontsize=12, fontweight='bold')
ax.set_title('Post-Surgical Symptom Score (Randomized Assignment)', fontsize=14, fontweight='bold', pad=15)
ax.grid(True, alpha=0.3, linestyle='-', linewidth=0.5)
ax.legend(loc='upper right', fontsize=11, framealpha=0.9)
ax.set_xlim(-2, 110)

# Adjust tick labels
ax.tick_params(labelsize=10)

plt.tight_layout()
plt.show()

```
 

### Figure 3 — Outcomes by Patient Severity (Stratification)

```{python}
#| label: fig-plot-outcomes-severity
#| fig-cap: "Post-Surgical Symptom Score (lower is better) by Patient and Severity"
#| echo: false

import matplotlib.pyplot as plt
import numpy as np

# Separate data by doctor
dreamy_data = patients_df[patients_df['doctor_name'] == 'Doc Dreamy']
duck_data = patients_df[patients_df['doctor_name'] == 'Doc Duck']

# Calculate means
dreamy_mean = dreamy_data['post_surgical_score'].mean()
duck_mean = duck_data['post_surgical_score'].mean()

# Create figure with professional styling
fig, ax = plt.subplots(figsize=(7, 4))

# Add shaded region highlighting severity between -1 and 1 (behind everything)
ax.axvspan(-1, 1, alpha=0.15, color='gray', zorder=0)

# Plot scatter points
# Doc Dreamy: circles, blue
ax.scatter(dreamy_data['severity'], dreamy_data['post_surgical_score'], 
           marker='o', color='#4E79A7', s=60, alpha=0.7, label='Doc Dreamy', zorder=3)

# Doc Duck: triangles, coral/red-orange
ax.scatter(duck_data['severity'], duck_data['post_surgical_score'], 
           marker='^', color='#E15759', s=60, alpha=0.7, label='Doc Duck', zorder=3)

# Add horizontal dashed lines for means
ax.axhline(y=dreamy_mean, color='#4E79A7', linestyle='--', linewidth=1.5, alpha=0.8, zorder=2)
ax.axhline(y=duck_mean, color='#E15759', linestyle='--', linewidth=1.5, alpha=0.8, zorder=2)

# Set x-axis limits to accommodate annotations
x_min = min(patients_df['severity'].min(), -3.0)
x_max = max(patients_df['severity'].max(), 3.0)

# Professional styling
ax.set_xlabel('Initial Patient Severity', fontsize=12, fontweight='bold')
ax.set_ylabel('Post-Surgical Symptom Score (Lower is Better)', fontsize=12, fontweight='bold')
ax.set_title('Post-Surgical Symptom Score by Patient Severity', fontsize=14, fontweight='bold', pad=15)
ax.grid(True, alpha=0.3, linestyle='-', linewidth=0.5)
ax.legend(loc='upper right', fontsize=11, framealpha=0.9)
ax.set_xlim(left=x_min, right=x_max + 0.8)

# Add text annotations with shape symbols positioned on the right side
ax.text(x_max + 0.2, dreamy_mean, f'○ {dreamy_mean:.2f}', 
        color='#4E79A7', fontsize=11, va='center', fontweight='bold')
ax.text(x_max + 0.2, duck_mean, f'△ {duck_mean:.2f}', 
        color='#E15759', fontsize=11, va='center', fontweight='bold')

# Adjust tick labels
ax.tick_params(labelsize=10)

plt.tight_layout()
plt.show()

```

